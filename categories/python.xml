<?xml version="1.0" encoding="utf-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>Etienne’s blog (Python)</title><link>http://getnikola.com/</link><description>Python, technology and maybe more</description><atom:link href="http://getnikola.com/categories/python.xml" type="application/rss+xml" rel="self"></atom:link><lastBuildDate>Tue, 15 Oct 2013 20:58:12 GMT</lastBuildDate><generator>nikola</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>The Margarita Project</title><link>http://getnikola.com/posts/the-margarita-project.html</link><description>&lt;p&gt;My project is to build a controller for my house's air exchanger that will optimize its utilization. It will take into account the exterior and interior temperature and humidity to decide what the exchanger should do. In a second time I will add a web/phone interface to access and set the controller. In fact I have a lot of other ideas and goals but better to don't make too much promise!&lt;/p&gt;
&lt;div class="section" id="the-problem-and-the-current-situation"&gt;
&lt;h2&gt;The problem and the current situation&lt;/h2&gt;
&lt;p&gt;I suffer from strong allergies so, a few years ago, I added to my house an air exchanger with &lt;a class="reference external" href="http://en.wikipedia.org/wiki/HEPA"&gt;HEPA&lt;/a&gt; filter, a &lt;a class="reference external" href="http://www.venmar.ca/61-air-exchangers-thh-1-0.html"&gt;Venmar/VanEE THH 1.0&lt;/a&gt;, to purify the inside air. Unfortunately the controllers that can work with this model are really limited (completely manual with only theses modes stop/slow/fast/recycle) or more targeted at managing the relative humidity. Not to mention that they are all pretty ugly. I really don't have any difficulties to understand why &lt;a class="reference external" href="http://www.theverge.com/2011/11/14/2559567/tony-fadell-nest-learning-thermostat"&gt;Tony Fadell created the Nest thermostat&lt;/a&gt;!&lt;/p&gt;
&lt;p&gt;What is needed for an exchanger targeted at purifying the air is to run it just enough to replace all the air of the house every day and maintaining a good humidity level at the same time. Not too dry in winter, not too humid in summer.&lt;/p&gt;
&lt;blockquote&gt;
In fact, a human at rest will &lt;em&gt;consume&lt;/em&gt; around 400 cubic feet of air a day (0.27 CFM). We are 5 humans living in my house. So I need to run the exchanger 45 min. at least each day at slow speed (45 CFM) to exit all the C02 we have created. It takes 12 hours at slow speed to change all the house’s air (30 000 cu ft). It means that, if I change all the house´s air everyday, CO2 level should be kept low enough. At start I was thinking about hooking also a CO2 meter to my controller but with these facts I think I just need to set my controller to run the exchanger at least 45 min. a day from exterior air and all will be fine.&lt;/blockquote&gt;
&lt;p&gt;So my current solution is to use my costly &lt;a class="reference external" href="http://www.aubetech.com/products/produitsDetails.php?noProduit=158&amp;amp;noLangue=2"&gt;Aube thermostat&lt;/a&gt; (TH146-P-U) that control my heating system and set it to control also the exchanger. I can set it to run the exchanger at a minimum of x minutes every hour and to run it more if the humidity is to high. But it's not possible to choose the fan speed, it's always at slow.&lt;/p&gt;
&lt;p&gt;Connecting the exchanger to this thermostat was not easy. There's no information on the 4 wires coming out from the exchanger (I called directly the manufacturer to ask for information but without success). These 4 wires come from a micro-controller on the exchanger board. I did some investigations and found that when 2 of the 4 wires are connected together the exchanger stop. So I added a relay between the thermostat relay and the exchanger to reverse the relay action. Unfortunately, with this setup, if I want to run the exchanger at full speed I still need to go in the basement and turn the button on the machine.&lt;/p&gt;
&lt;p&gt;About a year after I set up the exchanger with the thermostat, our house had a significant water infiltration that probably affected the exchanger. After this event the full speed was not working anymore. But I didn't use the full speed really often so I can't be sure if it's the water or how I wired the controller that did the harm. But I know that the problem is definitely in the micro-controller. All the rest of the board is working properly.&lt;/p&gt;
&lt;p&gt;So, this left me with two options:&lt;/p&gt;
&lt;ul class="simple"&gt;&lt;li&gt;Change the exchanger board for around 150$ and keep my current setup.&lt;/li&gt;
&lt;li&gt;Keep the old board and hook it to a custom controller that will fulfill my needs better that my current setup.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;I choose the second option.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="choosing-the-controller-hardware"&gt;
&lt;h2&gt;Choosing the controller hardware&lt;/h2&gt;
&lt;p&gt;The first time I heard about the &lt;a class="reference external" href="http://www.raspberrypi.org/"&gt;Raspberry Pi&lt;/a&gt; I immediately saw that was the perfect fit for my controller project. It would be easy for me to program the controller in Python, create a Phone interface by running a Web server and interface it with the exchanger and some sensors with the GPIO. So, I bought one.&lt;/p&gt;
&lt;p&gt;Just after buying it I stumbled on the &lt;a class="reference external" href="http://beagleboard.org/Products/BeagleBone%20Black"&gt;BeagleBone Black&lt;/a&gt; and it definitely look like another really good option for my project. The price is mostly the same (45$ for the BBB vs 35$ for RPi, but you need to buy an SD card for the later). Some advantages of the BBB is more IO (some analogs!) and a faster CPU. The flash memory instead of an SD card can be an advantage or disadvantage, it depends of the use. For me, it doesn't really matter. Some disadvantages are a less powerful video output (it doesn't matter for my project, there's no display) and a smaller community. &lt;em&gt;Makezine&lt;/em&gt; did a more &lt;a class="reference external" href="http://makezine.com/magazine/how-to-choose-the-right-platform-raspberry-pi-or-beaglebone-black/"&gt;thoughtful comparison&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In my case a micro-controller, like the &lt;a class="reference external" href="http://www.arduino.cc/"&gt;Arduino&lt;/a&gt;, is not a good match because I need to be able to run a Web server. I found only a few micro-controllers that can run a Web server like the &lt;a class="reference external" href="http://www.atmel.ca/devices/ATMEGA88.aspx"&gt;Atmega88&lt;/a&gt;, but the learning curve and complexity is a big disadvantage for no apparent advantage in return in my case.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="setting-up-the-raspberry-pi"&gt;
&lt;h2&gt;Setting up the Raspberry Pi&lt;/h2&gt;
&lt;div class="section" id="choose-a-linux-distribution"&gt;
&lt;h3&gt;Choose a Linux distribution&lt;/h3&gt;
&lt;p&gt;There's &lt;a class="reference external" href="http://elinux.org/RPi_Distributions"&gt;many Linux distributions&lt;/a&gt; for the Raspberry Pi. Personally I choosed &lt;a class="reference external" href="http://learn.adafruit.com/adafruit-raspberry-pi-educational-linux-distro/occidentalis-v0-dot-2"&gt;Occidentalis 0.2&lt;/a&gt; from &lt;a class="reference external" href="http://www.adafruit.com/"&gt;Adafruit&lt;/a&gt;. It's derived from &lt;a class="reference external" href="http://www.raspbian.org/"&gt;Raspbian&lt;/a&gt;. The good things about Occidentalis for me is:&lt;/p&gt;
&lt;ul class="simple"&gt;&lt;li&gt;Like Raspbian, it's based on Debian, my preferred Linux distro.&lt;/li&gt;
&lt;li&gt;Unlike Raspbian, the SSH daemon is already activated.&lt;/li&gt;
&lt;li&gt;And the avahi daemon is also already activated (Bonjour client).&lt;/li&gt;
&lt;li&gt;Many IO kernel modules are included.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;The most important thing for me is SSH and Bonjour because I don't have any display that I can hook to the RPi, so I need to be able to do everything via SSH from the start. With Bonjour I don't have to find/guess its IP address, I can just connect to &lt;em&gt;raspberrypi.local&lt;/em&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="installing-the-distro"&gt;
&lt;h3&gt;Installing the distro&lt;/h3&gt;
&lt;p&gt;I used a Mac to install the distro on the SD card. I only followed these &lt;a class="reference external" href="http://elinux.org/RPi_Easy_SD_Card_Setup#Using_command_line_tools_.282.29"&gt;instructions&lt;/a&gt; except that I used the &lt;a class="reference external" href="http://adafruit-raspberry-pi.s3.amazonaws.com/Occidentalisv02.zip"&gt;Occidentalis 0.2 image&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="expanding-the-sd-card"&gt;
&lt;h3&gt;Expanding the SD card&lt;/h3&gt;
&lt;p&gt;The SD card partition will be the same size as the distro image size, instead of the card size. So, on the first boot, it's a good idea to expand the root partition to fill the SD card. It's easy to do by choosing the &lt;em&gt;expand_rootfs&lt;/em&gt; menu option of the &lt;a class="reference external" href="http://elinux.org/RPi_raspi-config"&gt;raspi-config&lt;/a&gt; script.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="upgrading-the-system"&gt;
&lt;h3&gt;Upgrading the system&lt;/h3&gt;
&lt;p&gt;I think it's good idea to upgrade the OS:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo apt-get update
sudo apt-get upgrade
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="adjusting-the-memory"&gt;
&lt;h3&gt;Adjusting the memory&lt;/h3&gt;
&lt;p&gt;There are two things to adjust (at least in my case):&lt;/p&gt;
&lt;ol class="arabic"&gt;&lt;li&gt;&lt;p class="first"&gt;By default my RPi was using only 256 MB instead of the 512 MB. So I had to upgrade the firmware to access all the memory:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo rpi-update
&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Some memory is used by the GPU. It's possible to change how much memory the GPU will used. In my case, as I will not use an external display, I set it to the minimum:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo raspi-config
&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;Then choose the &lt;em&gt;Memory Split&lt;/em&gt; option in the &lt;em&gt;Advanced Options&lt;/em&gt; option. I set the GPU memory to 16 MB, which is the minimum.&lt;/p&gt;
&lt;p&gt;It's possible also to &lt;a class="reference external" href="http://elinux.org/RPiconfig#Memory"&gt;set the memory to be split dynamically (CMA)&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="connect-it-directly-to-a-mac"&gt;
&lt;h3&gt;Connect it directly to a Mac&lt;/h3&gt;
&lt;p&gt;When I connect my RPi on my LAN, as I use the Occidentalis distro, I can connect to it simply like this:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ssh pi@rasbpberrypi.local
&lt;/pre&gt;
&lt;p&gt;Unfortunately I don't have a WiFi dongle on my RPi and my router is far from my main computer but I would like to have the RPi next to my main computer to ease development. The solution is to connect the Ethernet cable directly in my Mac and share the Mac Internet (WiFi) connection. By sharing the Internet connection, the Mac will create a subnet on 192.168.2.x and will assign dynamically an address to the RPi. So, by sharing the Internet connection, you get two things: a subnet with an address for the RPi so you can now connect to the RPi from your Mac, and Internet access to the RPi. No need to turn on IPV6 on the RPi or to install &lt;em&gt;avahi-autoipd&lt;/em&gt;, as others suggested.&lt;/p&gt;
&lt;p&gt;Unfortunately that did not work for me on the first try (and many tries after!), until I flash that my LAN was already using the 192.168.2.x subnet! I switched my LAN to another subnet and everything started to work. Another solution, if you can't change the LAN subnet is to &lt;a class="reference external" href="http://blog.chariotsolutions.com/2013/03/configuring-network-used-by-mac-os-x.html"&gt;change the default address&lt;/a&gt; used by the Mac Internet sharing.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="setting-up-a-proper-python-environment"&gt;
&lt;h3&gt;Setting up a proper python environment&lt;/h3&gt;
&lt;p&gt;I will use mainly python to develop my application. So to work comfortably I set up a few things python related (the usuel suspects: &lt;a class="reference external" href="http://www.pip-installer.org/"&gt;pip&lt;/a&gt;, &lt;a class="reference external" href="http://ipython.org/"&gt;ipython&lt;/a&gt;, &lt;a class="reference external" href="http://www.virtualenv.org/"&gt;virtualenv&lt;/a&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo easy_install pip
$ sudo pip install ipython
$ sudo pip install virtualenv
$ mkdir venv
$ cd venv
$ virtualenv --system-site-packages margarita
$ cd
$ source venv/margarita/bin/activate
&lt;/pre&gt;
&lt;p&gt;I also installed vim because vim.tiny, installed by default, lacks too many features:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo apt-get install vim
&lt;/pre&gt;
&lt;p&gt;That's enough for now. Next time I will write about reading the sensors and controlling the relays.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;</description><category>Raspberry Pi</category><category>Python</category><category>Margarita</category><category>HRV</category><guid>http://getnikola.com/posts/the-margarita-project.html</guid><pubDate>Fri, 20 Sep 2013 21:40:03 GMT</pubDate></item></channel></rss>